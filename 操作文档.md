# 📖 Insurance RAG 系统 - 操作文档

> **项目状态：✅ 已就绪，可直接运行**

本文档提供完整的项目运行指南，包括环境配置、启动步骤、数据导入和功能使用说明。

---

## 📋 目录

1. [环境要求](#环境要求)
2. [快速开始（5分钟）](#快速开始5分钟)
3. [详细配置步骤](#详细配置步骤)
4. [运行项目](#运行项目)
5. [导入保险数据](#导入保险数据)
6. [功能使用说明](#功能使用说明)
7. [常见问题排查](#常见问题排查)
8. [项目结构说明](#项目结构说明)

---

## 🔧 环境要求

### 必需环境

- **Node.js** 18.0 或更高版本
  ```bash
  node --version  # 应显示 v18.x.x 或更高
  ```

- **npm** 或 **yarn** 包管理器
  ```bash
  npm --version  # 应显示 9.x.x 或更高
  ```

### 必需服务

1. **Supabase 项目**
   - 注册地址：https://supabase.com
   - 需要启用 `pgvector` 扩展（用于向量检索）

2. **OpenAI API Key**
   - 注册地址：https://platform.openai.com
   - 需要 API 访问权限

---

## ⚡ 快速开始（5分钟）

### 步骤 1：克隆/进入项目目录

```bash
cd E:\code\cursor\insurance-rag
```

### 步骤 2：安装依赖

```bash
npm install
```

### 步骤 3：配置环境变量

在项目根目录创建 `.env.local` 文件：

```env
# Supabase 配置（必需）
SUPABASE_URL=https://你的项目ID.supabase.co
SUPABASE_SERVICE_ROLE_KEY=你的service_role密钥
NEXT_PUBLIC_SUPABASE_ANON_KEY=你的anon_key（可选）

# OpenAI 配置（必需）
OPENAI_API_KEY=sk-你的API密钥
OPENAI_BASE_URL=可选，如果使用代理网关

# 模型配置（可选，有默认值）
EMBEDDING_MODEL=text-embedding-3-small
GENERATION_MODEL=gpt-4o-mini
```

**如何获取密钥：**
- **Supabase**：项目设置 → API → 复制 URL 和密钥
- **OpenAI**：平台设置 → API keys → 创建新密钥

### 步骤 4：初始化数据库

1. 打开 Supabase 控制台 → SQL Editor
2. 打开项目中的 `supabase/sql/001_rag_schema.sql` 文件
3. 复制全部 SQL 代码到 SQL Editor
4. 点击 **Run** 执行

### 步骤 5：验证系统

```bash
# 运行诊断脚本
npx tsx scripts/diag.ts
```

**预期输出：**
```
✅ ✨ 端到端 RAG 链路正常！
```

### 步骤 6：启动开发服务器

```bash
npm run dev
```

**访问地址：** http://localhost:3000

---

## 📝 详细配置步骤

### 1. Supabase 项目设置

#### 1.1 创建项目
1. 访问 https://supabase.com 并登录
2. 点击 **New Project**
3. 填写项目名称、数据库密码
4. 选择区域（建议选择离你最近的）
5. 等待项目创建完成（约 2 分钟）

#### 1.2 启用 pgvector 扩展
1. 进入项目 → **Database** → **Extensions**
2. 搜索 `pgvector`
3. 点击 **Enable**

#### 1.3 获取 API 密钥
1. 进入 **Settings** → **API**
2. 复制以下信息：
   - **Project URL** → 填入 `SUPABASE_URL`
   - **service_role key** → 填入 `SUPABASE_SERVICE_ROLE_KEY`（⚠️ 保密）
   - **anon public key** → 填入 `NEXT_PUBLIC_SUPABASE_ANON_KEY`（可选）

### 2. OpenAI API 设置

#### 2.1 获取 API Key
1. 访问 https://platform.openai.com
2. 登录账户
3. 进入 **API keys** 页面
4. 点击 **Create new secret key**
5. 复制密钥 → 填入 `OPENAI_API_KEY`

#### 2.2 检查余额
- 确保账户有足够余额（建议至少 $5）
- 每次查询消耗约 $0.001-0.002（取决于模型）

### 3. 环境变量文件

创建 `.env.local` 文件（**不要提交到 Git**）：

```env
# ============================================
# Supabase 配置
# ============================================
SUPABASE_URL=https://xxxxx.supabase.co
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# ============================================
# OpenAI 配置
# ============================================
OPENAI_API_KEY=sk-proj-xxxxx
OPENAI_BASE_URL=可选，如使用代理：https://api.openai-proxy.com/v1

# ============================================
# 模型配置（可选，有默认值）
# ============================================
EMBEDDING_MODEL=text-embedding-3-small
GENERATION_MODEL=gpt-4o-mini
```

---

## 🚀 运行项目

### 开发模式

```bash
# 启动开发服务器（支持热重载）
npm run dev
```

**访问：** http://localhost:3000

**特点：**
- 代码修改后自动刷新
- 显示详细错误信息
- 支持调试

### 生产模式

```bash
# 构建生产版本
npm run build

# 启动生产服务器
npm start
```

**访问：** http://localhost:3000

**特点：**
- 代码已优化和压缩
- 性能更好
- 适合部署

### 停止服务器

在终端中按 `Ctrl + C`

---

## 📥 导入保险数据

### 方式一：使用 AI 自动抽取（推荐）

只需提供产品名称和原始内容，系统会自动抽取 `description` 和 `clauses`：

1. 编辑 `scripts/seedData.ts` 文件
2. 添加新产品数据：

```typescript
export const productsToInsert: SeedProduct[] = [
  {
    name: '康宁保重疾险',
    content: '保障重疾/中症/轻症，重疾最高给付 50 万；无等待期重疾不可赔付；对既往症除外；可附加投保人豁免。',
  },
  {
    name: '金悦年金险',
    content: '年金按期给付，保证给付期 20 年；身故返还已交保费或保单现金价值孰高；投保年龄 0-65 岁。',
  },
];
```

3. 运行导入脚本：

```bash
npx tsx scripts/seed.ts
```

**输出示例：**
```
共 2 个产品待处理...

[1/2] 处理产品：康宁保重疾险
  检测到原始内容 content，调用模型抽取 description 与 clauses...
  抽取完成：description=有，clauses=5 条
  已创建产品（id=1）
  [1/5] 条款已写入
  ...
产品 康宁保重疾险 处理完成。

==== 导入总结报告 ====
产品：创建 2，更新 0，跳过 0，失败 0
条款：插入 10，跳过 0，失败 0

全部成功 ✅
```

### 方式二：手动提供结构化数据

如果你已有结构化的数据，可以直接提供：

```typescript
export const productsToInsert: SeedProduct[] = [
  {
    name: '安心无忧医疗险',
    description: '百万医疗，重疾保障',
    clauses: [
      '本合同对既往症除外，等待期为 30 天。',
      '住院医疗费用 100% 报销，年度免赔额 1 万元。',
      '重疾确诊一次性给付 10 万元。',
    ],
  },
];
```

### 数据导入特性

- ✅ **幂等导入**：重复运行不会创建重复数据
- ✅ **自动去重**：相同产品名和条款内容会自动跳过
- ✅ **智能抽取**：使用 AI 从原始文本自动提取结构化信息
- ✅ **详细报告**：显示创建/更新/跳过/失败的统计

---

## 🎯 功能使用说明

### 1. 搜索保险产品

1. 在首页搜索框输入产品名称（如：`平安福`、`尊享一生`）
2. 点击 **查询** 按钮或按 `Enter`
3. 等待 AI 分析（约 3-5 秒）
4. 查看结构化结果

### 2. 查看结果卡片

结果页面包含以下信息：

- **产品概况**：产品简介和标签
- **适合人群**：目标客户描述
- **核心保障权益**：保障项目、保额、说明
- **责任免除**：重点关注的不保事项
- **AI 推荐销售话术**：2-5 条销售建议
- **条款原文摘要**：可展开查看原始条款片段

### 3. 导出 PDF

1. 在结果页面点击 **导出 PDF** 按钮
2. 浏览器会打开打印对话框
3. 选择 **另存为 PDF**
4. 建议文件名：`{产品名}-{日期}.pdf`

**打印内容包含：**
- 产品名称、概况、核心保障、免责、适合人群、销售话术
- 不包含：输入框、按钮等交互元素

### 4. 复制话术

1. 在结果页面点击 **复制话术** 按钮
2. 按钮会显示 **已复制 ✓**（2 秒后恢复）
3. 粘贴到任意文本编辑器即可使用

**复制格式：**
```
【产品】平安福
概览：这是一款综合保障型保险产品...
1) 为家庭提供全面保障，覆盖重疾、意外、医疗...
2) 保费灵活，可根据预算选择不同保额...
3) 理赔便捷，线上申请快速到账...
```

### 5. 回到首页

1. 点击右上角 **回到首页** 按钮（仅在查询后显示）
2. 系统会清空所有查询状态
3. 自动滚动到顶部并聚焦搜索框

### 6. 未导入险种提示

如果输入的险种在数据库中**存在但无条款数据**，系统会：

1. 在输入框下方实时显示提示（500ms 防抖）
2. 显示 **"此类保险未导入"** 卡片
3. 提供相似产品建议（可点击快速替换）
4. 拦截提交，避免无效查询

---

## 🔍 常见问题排查

### 问题 1：诊断脚本报错 "缺少 SUPABASE_SERVICE_ROLE_KEY"

**原因：** 环境变量未正确配置

**解决：**
1. 检查 `.env.local` 文件是否存在
2. 确认文件中有 `SUPABASE_SERVICE_ROLE_KEY=...` 这一行
3. 重启开发服务器：`npm run dev`

### 问题 2：match_clauses RPC 调用失败

**原因：** 数据库未初始化或 RPC 函数不存在

**解决：**
1. 打开 Supabase SQL Editor
2. 执行 `supabase/sql/001_rag_schema.sql` 中的全部 SQL
3. 确认 `match_clauses` 函数已创建

### 问题 3：维度不匹配警告

**原因：** 数据库中的向量维度与配置不一致

**解决：**
1. 检查 `.env.local` 中的 `EMBEDDING_MODEL=text-embedding-3-small`
2. 确认数据库 `clauses.embedding` 列维度为 1536
3. 如果维度不一致，需要重新生成向量（运行 `seed.ts` 会覆盖旧数据）

### 问题 4：查询返回空结果

**原因：** 数据库中无数据

**解决：**
```bash
# 运行数据导入脚本
npx tsx scripts/seed.ts
```

### 问题 5：OpenAI API 调用失败

**原因：** API Key 无效或余额不足

**解决：**
1. 检查 `.env.local` 中的 `OPENAI_API_KEY` 是否正确
2. 访问 https://platform.openai.com 检查账户余额
3. 确认 API Key 有访问权限

### 问题 6：端口 3000 已被占用

**原因：** 其他程序占用了 3000 端口

**解决：**
```bash
# Windows
netstat -ano | findstr :3000
taskkill /PID <进程ID> /F

# 或使用其他端口
PORT=3001 npm run dev
```

### 问题 7：复制话术功能不工作

**原因：** 浏览器安全限制或 HTTPS 要求

**解决：**
1. 确保在 `localhost` 或 HTTPS 环境下使用
2. 检查浏览器控制台是否有错误
3. 尝试手动复制（选中文本后 Ctrl+C）

---

## 📁 项目结构说明

```
insurance-rag/
├── src/
│   ├── app/
│   │   ├── api/
│   │   │   ├── health/route.ts          # 健康检查接口
│   │   │   ├── search/route.ts          # RAG 查询接口
│   │   │   └── products/
│   │   │       └── check/route.ts       # 产品存在性检查接口
│   │   ├── page.tsx                      # 前端主页面
│   │   ├── layout.tsx                    # 布局组件
│   │   └── globals.css                   # 全局样式（含打印样式）
│   └── lib/
│       └── supabaseClient.ts             # Supabase 客户端
├── scripts/
│   ├── diag.ts                           # 诊断脚本（检查系统状态）
│   ├── seed.ts                           # 数据导入脚本（支持 AI 抽取）
│   └── seedData.ts                       # 待导入的数据文件
├── supabase/
│   └── sql/
│       └── 001_rag_schema.sql            # 数据库初始化 SQL
├── .env.local                            # 环境变量（不提交到 Git）
├── package.json                          # 项目依赖配置
├── next.config.ts                        # Next.js 配置
├── tsconfig.json                         # TypeScript 配置
├── README.md                             # 项目概述
├── 操作文档.md                           # 本文件
└── 开始使用.md                           # 快速开始指南
```

---

## 🛠️ 开发命令

```bash
# 开发模式（热重载）
npm run dev

# 构建生产版本
npm run build

# 启动生产服务器
npm start

# 运行诊断脚本
npx tsx scripts/diag.ts

# 导入数据
npx tsx scripts/seed.ts

# 代码检查
npm run lint
```

---

## 📊 系统检查清单

在部署或分享项目前，确认以下项目：

- [ ] `.env.local` 文件已创建并配置正确
- [ ] Supabase 数据库已初始化（执行 SQL 脚本）
- [ ] 诊断脚本运行成功（`npx tsx scripts/diag.ts`）
- [ ] 至少导入了一条测试数据（`npx tsx scripts/seed.ts`）
- [ ] 开发服务器能正常启动（`npm run dev`）
- [ ] 前端页面能正常访问（http://localhost:3000）
- [ ] 能成功查询并显示结果
- [ ] 导出 PDF 功能正常
- [ ] 复制话术功能正常

---

## 🎉 开始使用

完成以上步骤后，你就可以：

1. ✅ 在首页搜索保险产品
2. ✅ 查看 AI 生成的结构化结果
3. ✅ 导出 PDF 文档
4. ✅ 复制销售话术
5. ✅ 导入新的保险产品数据

**祝你使用愉快！** 🚀

---

## 📞 需要帮助？

- 📖 查看 [`README.md`](./README.md) - 项目技术文档
- 📖 查看 [`开始使用.md`](./开始使用.md) - 快速开始指南
- 🔍 运行诊断脚本：`npx tsx scripts/diag.ts`
- 🌐 检查健康状态：访问 http://localhost:3000/api/health

---

**最后更新：** 2025-01-XX  
**项目版本：** v0.1.0  
**维护者：** 内部团队

